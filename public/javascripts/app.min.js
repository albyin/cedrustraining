var app = angular.module('ngMyApp', []);

// app.config(function ($urlRouterProvider, $locationProvider, $httpProvider) {
//     // This turns off hashbang urls (/#about) and changes it to something normal (/about)
//     $locationProvider.html5Mode(true);
//     // If we go to a URL that ui-router doesn't have registered, go to the "/" url.
//     $urlRouterProvider.otherwise('/');
// });

app.controller('mainController', ['$scope', 'Posts', 'Comments', function($scope, Posts, Comments){
		//define title
		$scope.title = 'Title comes from the controller';

		//immediately get all posts, put onto scope for display
		Posts.get()
			.then(function (data) {
				$scope.posts = data;
			});

		//toggle comments function, recieves a post object
		$scope.toggleComments = function (post) {
			//if post object already contains comments property, clear it
			if (post.comments) {
				post.comments = undefined;
			}
			//if post object does not have comments property, get comments and add it
			else {
				Comments.getAllByPostId(post.id)
				.then(function (data) {
					post.comments = data;
				});
			}
		};

	}]);

//API configuration factory
app.factory('APIConfig', [function (){
	return {
		//root api url for dev environment
		devRoot : 'http://jsonplaceholder.typicode.com/',
		//root api url for prod environment
		prodRoot: '',
		//current env
		env : 'dev',
		//set env function
		setEnv : function () {
		},
		//will return correct root URL based on current env
		getRoot : function () {
			//if env is dev, return devRoot, else return prodRoot
			if (this.env === 'dev') {
				return this.devRoot;
			}
			else if (this.env ==='prod') {
				return this.prodRoot;
			}

			//somehow neither of conditions above were satisfied, return null as error
			return null;
		}
	};
}]);

//factory to access posts
app.factory('Posts', ['$http', 'APIConfig', function($http, APIConfig){
  return {
  	//get all posts
    get : function() {
      return $http.get(APIConfig.getRoot() + 'posts/')
      	.then(function(res){
      		return res.data;
      	});
    }
  };
}]);

//factory to access comments
app.factory('Comments', ['$http', 'APIConfig', function($http, APIConfig){
	return {
		//get all comments
		get : function (){
			return $http.get(APIConfig.getRoot() + 'comments/')
      	.then(function(res){
      		return res.data;
      	});
		},
		//get all comments for a given postId
		getAllByPostId : function (postId){
			return $http.get(APIConfig.getRoot() + 'comments?postId=' + postId)
      	.then(function(res){
      		return res.data;
      	});
		}
	};
}]);

//factory to access users
app.factory('Users', ['$http', 'APIConfig', function($http, APIConfig){
	return {
		//get all users
		get : function (){
			return $http.get(APIConfig.getRoot() + 'users/')
      	.then(function(res){
      		return res.data;
      	});
		}
	};
}]);

// app.config(function ($stateProvider) {
//     $stateProvider.state('home', {
//         url: '/',
//         templateUrl: 'index.html', 
//         controller: "mainController"
//     });
// });